{%extends 'students/base.html.jinja'%}
{% block title %}
Requests
{% endblock title %}

{% block content %}
<section class="">
    <div class="bg-secondary py-4">
        <div class="container text-white">
            <div class="row align-items-center">
                <div class="col-2">
                    <div class="user-photo shadow" data-img="{{url_for('static',filename='images/male.webp')}}"></div>
                </div>
                <div class="col">
                    <h3 class="text-warning">{{g.student.firstname}} {{g.student.lastname}}</h3>
                    <p class="my-1">
                        <small>
                            Year Level: {{g.student.year_level}}
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container pt-4 pb-5">
        <p class="fs-5 text-secondary fw-bold">Account Profile</p>
        <hr>
        <div class="row justify-content-start">
            <div class="col-md-8">
                <p class="text-black-50"><small>Update Account</small></p>
                <form id="account-form" action="{{url_for('students.profile')}}" method="post">
                    <div class="mb-3">
                        <label for="" class="form-label">Firstname</label>
                        <input type="text" disabled value="{{g.student.firstname}}" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Middlename</label>
                        <input type="text" disabled value="{{g.student.middlename}}" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Lastname</label>
                        <input type="text" disabled value="{{g.student.middlename}}" class="form-control">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="" class="form-label fw-bold">Email:</label>
                        <input type="text" placeholder="Add an email" name="email" value="{{g.student.email}}"
                            class="form-control">
                    </div>
                    <div class="">
                        <div class="d-flex align-items-end">
                            <div class="w-100">
                                <div>
                                    <label for="" class="form-label fw-bold">Password:</label>
                                    <input type="password" required disabled id="old-password" value="password"
                                        class="form-control rounded-1">
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-c-light-dark rounded-0" id="edit-password" type="button">
                                    <i class="bx bx-edit"></i></button>
                            </div>
                        </div>
                    </div>
                    <span class=" text-danger mt-2 d-none" id="label-incorrect"><small>Incorrect password</small></span>


                    <div id="new-password" class="mt-3 d-none">
                        <label for="" class="form-label fw-bold">New Password</label>
                        <input type="text" name="new-password" required class="form-control rounded-1 ">
                    </div>
                    <div class="mt-4">
                        <button class="btn btn-c-secondary btn-sm form-btn" type="submit">Reset</button>
                        <button class="btn btn-success btn-sm ms-lg-2 form-btn" type="submit">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

{% include "students/components/request-modals.html.jinja" %}
{% endblock content %}


{% block scripts %}

<script>
    const showModal = (requestId, status) => {
        const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"]
        $.ajax({
            url: "{{url_for('students.get_request')}}",
            method: "POST",
            data: { id: requestId },
            dataType: "json",
            success: function (res) {
                console.log('res: ', res)
                let date = new Date(res.date)
                $("#status").html(status)
                $("#request_id").html(res.rental_no)
                $("#no_of_books").html(res.details.length)
                $("#date_requested").html(`${months[date.getMonth()]}. ${date.getDate() < 10 ? '0' + date.getDate() : date.getDate()}, ${date.getFullYear()}`)

                $("#content").removeClass("d-none")
                $("#info-placeholders").addClass("d-none")
                $("#info-id").val(res.id)

                //set action button to display
                $(".action-btn").addClass("d-none")
                if (status.toLowerCase() === "pending") {
                    $("#cancel").removeClass("d-none")
                }
                else if (status.toLowerCase() === "completed") {
                    $("#remove").removeClass("d-none")
                }

            },
            error: function (err) {
                console.log('err: ', err)
            }
        })

        $("#info-modal").modal('show')
    }

    $(".pending-btn").on("click", function (e) {
        let id = $(this).data('id')
        showModal(id, "Pending")
    })
    $(".declined-btn").on("click", function (e) {
        let id = $(this).data('id')
        showModal(id, "Declined")
    })

    $(".action-btn").on("click", function (e) {
        e.preventDefault()
        let id = $("#info-id").val()
        window.location.href = "{{url_for('students.delete_request')}}?id=" + id
    })

    $("#edit-password").on("click", function (e) {
        if ($("#old-password").attr('disabled')) {
            $(this).removeClass('btn-c-light-dark').addClass('btn-dark')
            $("#old-password").siblings('label').html('Old Password')
            $("#old-password").removeAttr('disabled')
            $("#old-password").val("")
            $("#old-password").attr('type', 'text')
            $("#new-password").removeClass("d-none")
        } else {
            $(this).removeClass('btn-dark').addClass('btn-c-light-dark')
            $("#new-password").addClass("d-none")
            $("#old-password").attr('type', 'password')
            $("#old-password").attr('disabled', true)
            $("#old-password").val("password")
            $("#old-password").siblings('label').html('Password')

        }
    })

    $("#account-form").on("submit", function (e) {
        e.preventDefault()
        let label = $("#label-incorrect")
        $(".form-btn").attr('disabled',true)
    })
</script>

{% endblock scripts %}